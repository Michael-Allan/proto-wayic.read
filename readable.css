/* readable - Wayscript that’s readable on the web
 *
 *   This renderer does what’s needed in order to present a complete, easily readable copy
 *   of a wayscript document for public viewing.  Otherwise it tries to preserve the layout
 *   of the underlying wayscript source as it would appear to a wayscribe.
 *
 *
 * BASIC USAGE
 * -----------
 *   Insert this in the head element of the document:
 *
 *       <link rel='stylesheet' href='http://reluk.ca/project/wayic/read/readable.css'/> <!-- HERE CUSTOM -->
 *
 *   Append one of the following to the body element:
 *
 *            <script src='http://reluk.ca/project/wayic/read/readable.js'/> <!-- HERE CUSTOM -->
 *       <html:script src='http://reluk.ca/project/wayic/read/readable.js'/> <!-- HERE CUSTOM -->
 *
 *   Append the second form when the body’s default namespace is other than XHTML.  For example:
 *
 *       <html:body xmlns='data:,wayscript.bit' xmlns:html='http://www.w3.org/1999/xhtml'>
 *                   ⋮
 *           <html:script src='http://reluk.ca/project/wayic/read/readable.js'/> <!-- HERE CUSTOM -->
 *           </html:body>
 *
 * APPEARANCE
 * ----------
 *   This renderer automatically chooses one of two overall lighting modes for the display:
 *   either a black-on-white *paper* mode. or a reverse video *neon* mode.  It bases the choice
 *   on what it detects of the browser settings, which it takes to be the user’s preference.
 *
 *
 * ANONYMOUS ELEMENT AND PREFIX DECLARATIONS
 * -----------------------------------------
 *   This renderer takes as anonymous any wayscript element in which the local part of the name
 *   is encoded by a single underscore ‘_’.  It renders the element accordingly.  Likewise it gives
 *   an element with a namespace prefix of ‘_’ the same rendering as an element that has no prefix.
 *
 *
 * COMPOSITION LEADER ALIGNMENT
 * ----------------------------
 *   In the source, it may happen that a composer start tag is followed on the same line by text
 *   or HTML content.  For example:
 *
 *       <cog:including>, as it may happen
 *
 *   When the renderer encounters this, it tries to reproduce a similar layout.
 *
 *
 * TROUBLESHOOTING
 * ---------------
 *   This renderer reports problems it detects to the browser’s debugging console. [CONS]
 *
 *   Direct rendering from the file system
 *   - - - - - - - - - - - - - - - - - - -
 *   When a wayscript document is loaded into the browser on a ‘file’ scheme URL, the renderer assumes
 *   you are its author.  Then it will open an *alert* window for any problem such as
 *   malformed content, or anything else that an author might be able to remedy.
 *
 *   Cross-file waylinks may fail to resolve under a ‘file’ scheme URL, instead being marked '⋯?⋯'.
 *   See support file local_access/_wayic.read_local_access.html for instructions on dealing with this.
 *
 *
 * NOTES  (continued at bottom)
 * -----
 */
@namespace html 'http://www.w3.org/1999/xhtml';
@namespace rend 'data:,wayic.read';
@namespace  cog 'data:,wayscript.cog';
@namespace step 'data:,wayscript.bit.step'; /*
    Namespace ↗ 'data:,wayscript.bit' covers waybits *simply*.  These have no styling of their own.
  Rather they share the general styling of waybits in general. */


html|body
{
    display: none; /* pending layout completion by readable.js */
}


@media screen
{
    html|html{ margin: 0; padding: 0; }
    html|body
    {
        margin: 3em auto 5em auto; /* TRBL */
        max-width: 50em;
        padding: 0 0.7em 0 2.0em; /* TRBL - meeting constraints on BODY_L */
    }
}


html|a
{
    color: inherit; /* defeat, avoid the distraction and colour interference */
    text-decoration-color: transparent; /* redundant but for enabling a transition effect */
 /* text-decoration-skip: ink; *//* no support in Firefox, no matter, but avoid the console warning */
    transition-property: color, text-decoration-color;
}
html|a:hover
{
    text-decoration-line: underline;
}
html|a,
html|a::after
{
    transition: 0.2s ease-out 0.1s; /* Transit duration, timing function, onset delay.
      Delay to avoid distracting flash on passing. */
}


html|a::after
{
    content: '*';
    font-size: 0.9em;
    line-height: 0.5em; /* preserve the original line spacing despite the *vertical-align* of 'super' */
    text-decoration: none !important; /* defeat Chrome's staggered underline (fails, ignored) */
    transition-property: color;
    vertical-align: super;
}


/* - - -  neon   - - - - - - - - - - - -
 */
html[rend|lighting='neon'] > html|body
{
    background-color: hsl( 0, 0%, 20% ); /* night time */
               color: hsla( 0, 0%, 80% /* BRIGHT_TEXT, yet allowing brighter effects elsewhere */, .5 );
}                                                       /* generally rendered as OFF_WAY by default ↑ */
html[rend|lighting='neon'] *[rend|isOnWayBranch]
{
               color: hsl(  0, 0%, 80% );               /*                        ON_WAY here         */
}


html[rend|lighting='neon'] html|a:hover
{
    text-decoration-color: hsl( 190/*∼cyan*/, 100%, 60% ); /* BRIGHT_HYPERLINK */
}
html[rend|lighting='neon'] html|a::after
{
                   color: hsla( 190         , 100%, 60%, 0.5 ); /* = BRIGHT_HYPERLINK, OFF_WAY */
}
html[rend|lighting='neon'] *[rend|isOnWayBranch] html|a::after, /*                   ,  ON_WAY */
html[rend|lighting='neon'] html|a:hover::after
{
                   color: hsl(  190         , 100%, 60% );
}


/* - - -  paper  - - - - - - - - - - - -
 */
html[rend|lighting='paper'] > html|body
{
    background-color: hsl( 0, 0%, 93% ); /* bright white, yet allowing brighter touches here and there */
               color: hsla( 0, 0%, 7% /* DARK_TEXT, yet allowing darker effects elsewhere */, .4 );
}                                                  /* generally rendered as OFF_WAY by default ↑ */
html[rend|lighting='paper'] *[rend|isOnWayBranch]
{
               color: hsl(  0, 0%, 7% );           /*                        ON_WAY here         */
}


html[rend|lighting='paper'] html|a:hover
{
    text-decoration-color: hsl( 240/*blue*/, 100%, 50% ); /* DARK_HYPERLINK */
}
html[rend|lighting='paper']                       html|a::after
{
                   color: hsla( 240        , 100%, 50%, 0.4 ); /* = DARK_HYPERLINK, OFF_WAY */
}
html[rend|lighting='paper'] *[rend|isOnWayBranch] html|a::after, /*               ,  ON_WAY */
html[rend|lighting='paper'] html|a:hover::after
{
                   color: hsl(  240        , 100%, 50% );
}



/* ---  C o m p o s e r  -------------------------------------------------------------------------------
 */

*[rend|isComposer]
{
    border-radius: 0.5em;
    border-width: 0.1em;
           left: -0.1em; /* despite the border, maintain a precise text margin for appearance sake */
    margin-left:          -2.5em; /* meet constraints on COMPOSER_L */
    padding: 0.2em 0.2em 0.2em 2.5em; /* TRBL */
    position: relative;
}


*[rend|isComposer] [rend|isComposer] /* when nested */
{
    margin-right: 0.7em; /* space between adjacent, vertical border lines to better show the nesting */
}


*[rend|isComposer] > eSTag
{
    font-style: italic;
    opacity: 0.6;
    padding-left: 3em; /* ≥ NEST_INDENT, for any inline composition leader that flows to the next line */
    text-indent: -3em; /* but not on the first line, rather maintain its alignment */
}


*[rend|isComposer] > eSTag eQName > ePrefix
{
    display: none; /* assume that it's uninformative */
}


*[rend|isComposer] > eSTag eQName::after
{
    content: ':';
}


/* - - -  neon   - - - - - - - - - - - -
 */
html[rend|lighting='neon'] *[rend|isComposer]
{
    border-color: hsla( 0, 0%, 100%, 0.35 );
    border-style: dashed;
    margin-top: 0.2em !important; /* accomodate the borders */
    margin-bottom: 0.3em !important;
}


/* - - -  paper  - - - - - - - - - - - -
 */
html[rend|lighting='paper'] *[rend|isComposer]
{
    border-color: hsla( 0, 0%, 0%, 0.25 );
    border-style: solid none none solid; /* TRBL */
    box-shadow: 0.2em 0.3em 0.5em hsla(0,0%,0%,0.55); /* LR TB blur colour */
    margin-top: 0.3em !important; /* accomodate the shadows */
    margin-bottom: 0.7em !important;
}



/* ---  F l a s h   f a d e  ---------------------------------------------------------------------------
 */

@keyframes flashFade_outline_bright
{
    from { outline: medium solid hsl( 0, 0%, 100% ); animation-timing-function: linear }
     33% { outline: medium solid hsl( 0, 0%, 100% ); animation-timing-function: ease-out }
      to { outline: medium solid transparent }
}


@keyframes flashFade_outline_dark
{
    from { outline: medium solid hsl( 0, 0%,  0% ); animation-timing-function: linear }
     33% { outline: medium solid hsl( 0, 0%,  0% ); animation-timing-function: ease-out }
      to { outline: medium solid transparent }
}



/* ---  S t a r t   t a g  -----------------------------------------------------------------------------
 */

rend|eSTag
{
    display: block;
    margin-left: -2em; /* -NEST_INDENT, undoing it */
}


rend|eSTag eQName
{
    outline-offset: 0.2em;
}


rend|eSTag eQName[rend|isAnonymous] > eLocalPart /* renders as a mere bullet */
{
    cursor: default; /* defeat text cursor to avoid flash on passing, which distracts */
}


*:target > rend|eSTag eQName /* for a targeted waybit, whether targeted as a waylink or hyperlink */
{
    animation-duration: 2s;
}


/* - - -  neon   - - - - - - - - - - - -
 */
html[rend|lighting='neon'] *:target > rend|eSTag eQName
{
    animation-name: flashFade_outline_bright; /* as a target locator */
}


/* - - -  paper  - - - - - - - - - - - -
 */
html[rend|lighting='paper'] *:target > rend|eSTag eQName
{
    animation-name: flashFade_outline_dark; /* as a target locator */
}



/* ---  S t a r t   t a g  --  i n l i n e d  ----------------------------------------------------------
 *
 * These rules render the start tag in line with the leading flow content if it's short enough to allow
 * the flow content to rise alongside yet maintain its horizontal alignment.
 *
 * The inlining is effected by floating the start tag which allows the leading flow content fall in line.
 * If this method ever proves too difficult to maintain owing to the complications of the float layout,
 * then consider switching to the simpler, more direct method used by the old composer elements [COMP],
 * namely shipping the leading flow content into the start tag.  A drawback would be the loss
 * of uniform left alignment of the first line of flow content from one waybit to another.
 */

*[rend|hasShortName][rend|hasLeader]:not([rend|isChangeable])[rend|isWaybit] > eSTag
{
    float: left; /* rendering the element's start tag in line with its leading text content */
    margin-right: 0.5em;
}


step|*[rend|hasShortName][rend|hasLeader]:not([rend|isChangeable]) > rend|textAligner
{
    display: block;
}


/* - - -  neon   - - - - - - - - - - - -
 */
html[rend|lighting='neon']
step|*[rend|hasShortName][rend|hasLeader]:not([rend|isChangeable]) > rend|textAligner
{
    padding-top: 0.30em; /* = NEO_ST_MARG_T + ST_PAD_T */
}


/* - - -  paper  - - - - - - - - - - - -
 */
html[rend|lighting='paper']
step|*[rend|hasShortName][rend|hasLeader]:not([rend|isChangeable]) > rend|textAligner
{
    padding-top: 0.28em; /* = PAP_ST_MARG_T + ST_PAD_T + ST_BOR */
}



/* ---  S t e p  ---------------------------------------------------------------------------------------
 */

step|* > eSTag eQName
{
    border-radius: 0.15em / 15%; /* H / V */
    padding: 0.10em   0.20em   0.15em   0.25em; /* TRBL.  TB don't affect layout ∵ eLocalPart is inline, */
}        /* -------- -------- --------             but rather cause overlapping, ∴ constraints STEP_PAD_*.
            ST_PAD_T ST_PAD_L ST_PAD_B */

step|* > eSTag eQName > ePrefix,
step|* > eSTag eQName:not([rend|isAnonymous]) > eLocalPart /* not when isAnonymous ∵ then */
{                                                           /* it renders as a mere bullet */
    font-weight: bold;
}


step|* > eSTag eQName > ePrefix[rend|isAnonymous],
step|* > eSTag eQName:not([rend|isAnonymous]) > ePrefix
{
    display: none; /* let the local part stand alone */
}


step|* > eSTag eQName[rend|isAnonymous] > ePrefix:not([rend|isAnonymous]) + eLocalPart
{
    display: none; /* let the prefix stand alone */
}


/* - - -  neon   - - - - - - - - - - - -
 */
html[rend|lighting='neon'] step|* > eSTag
{
     margin-top:    0.20em; /* NEO_ST_MARG_T */
    padding-top:    0.10em; /* = ST_PAD_T */
    padding-bottom: 0.15em; /* = ST_PAD_B */
     margin-bottom: 0.20em;
}


html[rend|lighting='neon'] step|*                            > eSTag eQName
{
    margin-left: -0.20em; /* = -ST_PAD_L */

    background-color: hsla( 0, 0%, 100%, 0.22/* = .45 × .5 */ ); /* OFF_WAY */
               color: hsla( 0, 0%,   0%, 0.5 );
}
html[rend|lighting='neon']      *[rend|isOnWayBranch] step|* > eSTag eQName,
html[rend|lighting='neon'] step|*[rend|isOnWayBranch]        > eSTag eQName
{
    background-color: hsla( 0, 0%, 100%, 0.45/* = .45      */ ); /*  ON_WAY */
               color: hsl(  0, 0%,   0%      );
}


/* - - -  paper  - - - - - - - - - - - -
 */
html[rend|lighting='paper'] step|* > eSTag
{
     margin-top:    0.10em; /* PAP_ST_MARG_T */
    padding-top:    0.18em; /* = ST_PAD_T + ST_BOR */
    padding-bottom: 0.23em; /* = ST_PAD_B + ST_BOR */
     margin-bottom: 0.10em;
}


html[rend|lighting='paper'] step|*                            > eSTag eQName
{
    /* prominence for the steps, making them stand out at a glance from the other waybits */
    border-style: solid;
    border-width: 0.08em; /* ST_BOR */
    margin-left: -0.28em; /* = -(ST_PAD_L + ST_BOR), to maintain precise text alignment */

    background-color: hsla( 0, 0%, 100%, 0.16/* = .40 × .4 */ ); /* OFF_WAY */
        border-color: hsla( 0, 0%,   0%, 0.32/* = .80 × .4 */ );
}
html[rend|lighting='paper']      *[rend|isOnWayBranch] step|* > eSTag eQName,
html[rend|lighting='paper'] step|*[rend|isOnWayBranch]        > eSTag eQName
{
    background-color: hsla( 0, 0%, 100%, 0.40/* = .40      */ ); /*  ON_WAY */
        border-color: hsla( 0, 0%,   0%, 0.80/* = .80      */ );
}



/* ---  t e x t - A l i g n e r  -----------------------------------------------------------------------
 */

rend|textAligner
{
    display: none;
}



/* ---  W a y b i t  -----------------------------------------------------------------------------------
 */

*[rend|isWaybit]
{
    margin-left: 2em; /* NEST_INDENT to render the nesting of waybit dependents */
}



/* ---  W a y b i t  --  n o n - s t e p  --------------------------------------------------------------
 */

*[rend|isWaybit]:not(step|*) > eSTag
eQName > ePrefix
{
    display: none; /* assume that it's uninformative */
}


*[rend|isWaybit]:not(step|*) > eSTag
eQName:not([rend|isAnonymous]) > eLocalPart /* not when isAnonymous ∵ then it renders as a mere bullet */
{
    filter: contrast(1.4);
    font-weight: bold;
}



/* ---  W a y l i n k   s o u r c e   n o d e  ---------------------------------------------------------
 */

rend|forelinker > a,     /* override of the browser's default *a* styling */
rend|forelinker > a:hover /* override [OVGA] */
{
    text-decoration: none; /* symbols in the forelinker suffice */
}
rend|forelinker > a::after
{
    content: normal; /* [OVGA] */
}


rend|forelinker > a:focus:not(:active)
{
    outline: none; /* defeat (Firefox) ∵ its coverage of verticalTruncator is awkward and distracting */
}


*:not([rend|hasPreviewString]):not([rend|isChangeable]):not([rend|hasShortName]) >
rend|forelinker > a > br
{
    display: none; /* It happens that no text content precedes the injected *br* element.
      Therefore let it collapse to nothing.  But not when the source node has a short name;
      then the *br* is wanted to position the verticalTruncator below the node's start tag. */
}
*:not([rend|hasPreviewString]):not([rend|isChangeable]) >
rend|forelinker > a > verticalTruncator
{
    margin-left: -2em; /* = -NEST_INDENT, leaving only the click padding for indentation */
}


rend|forelinker > a > verticalTruncator
{
    opacity: 0.4;
    padding-left:  1em; /* extra click surface + indentation beneath the overlying preview text */
}
rend|forelinker > a:hover > verticalTruncator
{
    opacity: 1;
}


*[rend|isChangeable] >
rend|forelinker[class~='shortContent'] > a > verticalTruncator /* [C] */
{
 /* visibility: hidden; *//* It looks awkward and in most cases the short content itself will suffice
    to indicate that a waylink is present, so hide it.  Yet don't remove it entirely because it'll
    likely help preserve the stability of the layout in the event of the expected content change. */
}


rend|forelinker > a > directionIndicator /* content is an arrow */
{
    margin-left: 2em;

 /* visibility: hidden; */ /* but prefer opacity, as it allows for a more useful transition */
    opacity: 0;
    transition: opacity 0.2s ease-out 0.3s; /* Property, transit duration, timing function, onset delay.
      Delay to avoid distracting flash on passing. */
}


rend|forelinker > a:focus > directionIndicator, /* fails either entirely (Chrome 59),
                                     or when *href* is local to document (Firefox 52) */
rend|forelinker > a:hover > directionIndicator
{
    opacity: 1;
}


/* - - -  neon   - - - - - - - - - - - -
 */
html[rend|lighting='neon']
*[cog|link$="/actor/#commitment"] > eSTag > eQName > eLocalPart
{
    color: hsla( 36/*orange*/, 100%, 50%, 0.5 ); /* OFF_WAY */
}
html[rend|lighting='neon']                                      *[rend|isOnWayBranch]
*[cog|link$="/actor/#commitment"] > eSTag > eQName > eLocalPart
{
    color: hsl(  36          , 100%, 50%      ); /*  ON_WAY */
}


html[rend|lighting='neon']                       rend|forelinker > a > preview,
html[rend|lighting='neon']                       rend|forelinker > a > verticalTruncator
{
    color: hsla( 0, 0%, 80%, 0.5 ); /* = BRIGHT_TEXT, OFF_WAY */
}
html[rend|lighting='neon'] *[rend|isOnWayBranch] rend|forelinker > a > preview,
html[rend|lighting='neon'] *[rend|isOnWayBranch] rend|forelinker > a > verticalTruncator
{
    color: hsl(  0, 0%, 80%      ); /*              ,  ON_WAY */
}


html[rend|lighting='neon'] rend|forelinker > a:hover > verticalTruncator,
html[rend|lighting='neon'] rend|forelinker > a > directionIndicator
{
    color: hsl( 190/*∼cyan*/, 100%, 60% ); /* = BRIGHT_HYPERLINK */
}


/* - - -  paper  - - - - - - - - - - - -
 */
html[rend|lighting='paper']
*[cog|link$="/actor/#commitment"] > eSTag > eQName > eLocalPart
{
    color: hsla( 0/*red*/, 100%, 35%, 0.4 ); /* OFF_WAY */
}
html[rend|lighting='paper']                                     *[rend|isOnWayBranch]
*[cog|link$="/actor/#commitment"] > eSTag > eQName > eLocalPart
{
    color: hsl(  0       , 100%, 35%      ); /*  ON_WAY */
}


html[rend|lighting='paper']                       rend|forelinker > a > preview,
html[rend|lighting='paper']                       rend|forelinker > a > verticalTruncator
{
    color: hsla( 0, 0%, 7%, 0.4 ); /* = DARK_TEXT, OFF_WAY */
}
html[rend|lighting='paper'] *[rend|isOnWayBranch] rend|forelinker > a > preview,
html[rend|lighting='paper'] *[rend|isOnWayBranch] rend|forelinker > a > verticalTruncator
{
    color: hsl(  0, 0%, 7%      ); /*            ,  ON_WAY */
}


html[rend|lighting='paper'] rend|forelinker > a:hover > verticalTruncator,
html[rend|lighting='paper'] rend|forelinker > a > directionIndicator
{
    color: hsl( 240/*blue*/, 100%, 50% ); /* = DARK_HYPERLINK */
}



/* ---  W a y l i n k   t a r g e t   n o d e  ---------------------------------------------------------
 */

rend|eSTag > a /* wrapper for self-hyperlinking */
{
    position: relative; /* establish containing block for absolutely positioned descendants */

    margin-left: -2.0em; /* make space for targetMarker, ∴ BODY_L ≥ 2.0em, q.v. */
    padding-left: 2.0em;
}
rend|eSTag > a,     /* override of the browser's default *a* styling */
rend|eSTag > a:hover /* override [OVGA] */
{
    text-decoration: none; /* eSTag's targetMarker suffices */
}
rend|eSTag > a::after
{
    content: normal; /* [OVGA] */
}


[rend|isWaybit] * > /* viz. when moreover it's an underbit */
rend|eSTag > a
{
    margin-left: -3.5em; /* more space to better separate the targetMarker from overbit content */
    padding-left: 3.5em;
}


[rend|isWaybit] [rend|isComposer] > * > /* viz. when moreover it's a topmost component */
rend|eSTag > a
{
    margin-left: -2.0em; /* tighten it back up in this case, as there's no direct overbit content, */
    padding-left: 2.0em; /* and ∴ COMPOSER_L ≥ 2.0em, q.v. */
}


rend|eSTag > a > targetMarker
{
    position: absolute;
    left: 0; /* leftmost in the padding */
}


*:target > /* when it's hyperlink-targeted */
rend|eSTag > a > targetMarker
{
    cursor: default; /* Hyperlink *a* wrapper (with its cursor) are disabled by readable.js, bringing out
      the text cursor instead.  Defeat it to avoid flash on passing, which distracts. */
    opacity: 1 !important; /* indicate that it's targeted */
}


/* - - -  neon   - - - - - - - - - - - -
 */
html[rend|lighting='neon'] rend|eSTag > a > targetMarker
{
    opacity: 0.5;
}


html[rend|lighting='neon'] rend|eSTag > a > eQName
{
    outline-color: hsl( 0, 0%, 80% ); /* = BRIGHT_TEXT.  Cannot rely on outline-color's initial value
      of 'invert' because that keyword is rejected in the keyframes of flashFade_outline_* (at least by
      Firefox 52).  Nor is 'currentColor' useful, because if this element happens to be a step, and so
      has inverted colours, then currentColor will be the opposite of what's needed for the outline. */
}


/* - - -  paper  - - - - - - - - - - - -
 */
html[rend|lighting='paper'] rend|eSTag > a > targetMarker
{
    opacity: 0.3;
}


html[rend|lighting='paper'] rend|eSTag > a > eQName
{
    outline-color: hsl( 0, 0%,  7% ); /* = DARK_TEXT.  See comment on namesake above. */
}



/* ---  W a y s c r i p t  -----------------------------------------------------------------------------
 */

*[rend|isWayscript]
{
    clear: left;
    display: block;
    margin-top:    0.1em;
    margin-bottom: 0.1em;
}



/* NOTES
 * -----
 *  [BA]  A boolean attribute such as [rend|isFoo] either has the same value as the local part
 *        (‘isFoo’) of its name, meaning true; or the attribute is not present, meaning false.
 *
 *  [C]  Class selectors are failing for non-HTML elements under Chrome (59).  Therefore this style
 *       sheet selects non-HTML elements using a more general attribute selector: [class~='CLASS'].
 *
 *  [COMP]  Defunct composer elements, http://reluk.ca/project/wayic/read/composer/
 *
 *  [CONS]  https://console.spec.whatwg.org/
 *
 *  [OVGA]  Here overriding the general 'html|a' rule at top.
 *
 *  [XMLN]  https://www.w3.org/TR/xml-names/
 */


/* Copyright © 2017 Michael Allan and contributors.  Licence MIT. */
